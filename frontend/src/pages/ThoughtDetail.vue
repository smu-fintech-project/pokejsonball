<template>
  <section class="space-y-6">
    <router-link to="/community" class="text-sm text-gray-500 hover:underline">← Back to Community</router-link>

    <article v-if="thought" class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-gray-200 dark:border-slate-700">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-500 dark:text-slate-400">
          {{ thought.authorName || thought.authorEmail || 'Anonymous' }} · {{ formatDate(thought.createdAt) }}
        </div>
        <div class="flex items-center gap-2">
            <!-- Upvote -->
            <button
                :disabled="voteBusy"
                @click="onVoteThought(thought, 1)"
                class="px-3 py-1 rounded-lg border"
                :class="{
                'bg-red-600 text-white border-red-600': (thought.userVote || 0) === 1,
                'text-gray-600 hover:bg-gray-100 dark:hover:bg-slate-700 border-gray-300 dark:border-slate-600': (thought.userVote || 0) !== 1
                }"
                title="Upvote"
            >
                ▲
            </button>

            <!-- score (up - down) -->
            <span class="min-w-[2ch] text-center font-semibold">
                {{ (thought.upvotes || 0) - (thought.downvotes || 0) }}
            </span>

            <!-- Downvote -->
            <button
                :disabled="voteBusy"
                @click="onVoteThought(thought, -1)"
                class="px-3 py-1 rounded-lg border"
                :class="{
                'bg-slate-700 text-white border-slate-700': (thought.userVote || 0) === -1,
                'text-gray-600 hover:bg-gray-100 dark:hover:bg-slate-700 border-gray-300 dark:border-slate-600': (thought.userVote || 0) !== -1
                }"
                title="Downvote"
            >
                ▼
            </button>
        </div>
      </div>

      <h1 class="text-2xl font-bold mt-2 text-gray-900 dark:text-white">{{ thought.title }}</h1>
      <p class="mt-3 text-gray-700 dark:text-slate-300 whitespace-pre-wrap">{{ thought.body }}</p>
      <img v-if="thought.imageUrl" :src="thought.imageUrl" class="mt-4 rounded-xl w-full object-cover max-h-96">
    </article>

    <!-- Add comment -->
    <div v-if="isAuthenticated" class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-gray-200 dark:border-slate-700">
      <h3 class="font-semibold mb-2">Add a comment</h3>
      <textarea v-model="newComment" class="w-full p-3 rounded-lg border dark:bg-slate-700 dark:text-white" rows="4"
        placeholder="Be kind. Share helpful insights or questions."></textarea>
      <div class="mt-3 flex justify-end">
        <button @click="submitComment" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">
          Comment
        </button>
      </div>
    </div>

    <!-- Comments -->
    <div class="space-y-4">
      <div v-for="c in comments" :key="c.id" class="bg-white dark:bg-slate-800 rounded-2xl p-5 border border-gray-200 dark:border-slate-700">
        <div class="text-sm text-gray-500 dark:text-slate-400">
          {{ c.authorName || c.authorEmail || 'Anonymous' }} · {{ formatDate(c.createdAt) }}
        </div>
        <p class="mt-2 text-gray-800 dark:text-slate-200 whitespace-pre-wrap">{{ c.body }}</p>
        <div class="mt-3 flex items-center gap-2">
        <!-- Upvote -->
        <button
            :disabled="c.voteBusy"
            @click="onVoteComment(c, 1)"
            class="px-2 py-1 rounded border"
            :class="{
            'bg-red-600 text-white border-red-600': (c.userVote || 0) === 1,
            'text-gray-600 hover:bg-gray-100 dark:hover:bg-slate-700 border-gray-300 dark:border-slate-600': (c.userVote || 0) !== 1
            }"
            title="Upvote"
        >▲</button>

        <!-- score -->
        <span class="min-w-[2ch] text-center font-semibold">
            {{ (c.upvotes || 0) - (c.downvotes || 0) }}
        </span>

        <!-- Downvote -->
        <button
                :disabled="c.voteBusy"
                @click="onVoteComment(c, -1)"
                class="px-2 py-1 rounded border"
                :class="{
                'bg-slate-700 text-white border-slate-700': (c.userVote || 0) === -1,
                'text-gray-600 hover:bg-gray-100 dark:hover:bg-slate-700 border-gray-300 dark:border-slate-600': (c.userVote || 0) !== -1
                }"
                title="Downvote"
            >▼</button>

            <button @click="shareComment(c)" class="text-gray-500 hover:text-gray-700 ml-auto">↗︎ Share</button>
            </div>

      </div>
    </div>

    <div class="text-center" v-if="nextCursor">
      <button @click="loadMore" class="mt-2 px-5 py-2 rounded-lg border font-medium">Load more</button>
    </div>
  </section>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import {
  fetchThought, fetchComments, addCommentApi, voteThought, voteComment as voteCommentApi
} from '@/utils/api';
import { isAuthenticated as checkAuth } from '@/utils/api';

const route = useRoute();
const thoughtId = route.params.id;

const thought = ref(null);
const comments = ref([]);
const nextCursor = ref(null);
const newComment = ref('');
const isAuthenticated = checkAuth();

function formatDate(iso) {
  try { return new Date(iso).toLocaleString(); } catch { return '' }
}

async function loadThought() {
  const t = await fetchThought(thoughtId);
  // Ensure defaults for UI
  t.userVote = t.userVote ?? 0;
  t.upvotes = t.upvotes ?? 0;
  t.downvotes = t.downvotes ?? 0;
  thought.value = t;
}

async function loadComments(cursor = null) {
  const { items, nextCursor: nxt } = await fetchComments(thoughtId, { limit: 20, cursor });
  for (const c of items) {
    c.userVote = c.userVote ?? 0;
    c.upvotes = c.upvotes ?? 0;
    c.downvotes = c.downvotes ?? 0;
    c.voteBusy = false;
  }
  if (!cursor) comments.value = items; else comments.value.push(...items);
  nextCursor.value = nxt;
}

async function loadMore() {
  if (nextCursor.value) await loadComments(nextCursor.value);
}

async function submitComment() {
  if (!newComment.value.trim()) return;
  const c = await addCommentApi(thoughtId, { body: newComment.value.trim() });
  comments.value.push(c);
  newComment.value = '';
  thought.value.commentsCount = (thought.value.commentsCount || 0) + 1;
}

async function onVoteThought(th, clickValue) {
  if (voteBusy.value) return;
  voteBusy.value = true;

  const current = th.userVote || 0;
  // toggle: click again => unvote (0)
  const next = current === clickValue ? 0 : clickValue;

  // optimistic UI
  const prev = { up: th.upvotes || 0, down: th.downvotes || 0, userVote: current };
  applyOptimistic(th, next);

  try {
    // backend should accept { value: -1|0|1 } and ideally return { upvotes, downvotes, userVote }
    const resp = await voteThought(thoughtId, next);
    if (resp?.upvotes != null) th.upvotes = resp.upvotes;
    if (resp?.downvotes != null) th.downvotes = resp.downvotes;
    if (resp?.userVote != null) th.userVote = resp.userVote;
  } catch (e) {
    // rollback on error
    th.upvotes = prev.up;
    th.downvotes = prev.down;
    th.userVote = prev.userVote;
    console.error('vote failed', e);
  } finally {
    voteBusy.value = false;
  }
}


async function onVoteComment(c, clickValue) {
  if (c.voteBusy) return;
  c.voteBusy = true;

  const current = c.userVote || 0;
  const next = current === clickValue ? 0 : clickValue;

  const prev = { up: c.upvotes || 0, down: c.downvotes || 0, userVote: current };
  applyOptimisticComment(c, next);

  try {
    const resp = await voteCommentApi(thoughtId, c.id, next);
    if (resp?.upvotes != null) c.upvotes = resp.upvotes;
    if (resp?.downvotes != null) c.downvotes = resp.downvotes;
    if (resp?.userVote != null) c.userVote = resp.userVote;
  } catch (e) {
    c.upvotes = prev.up;
    c.downvotes = prev.down;
    c.userVote = prev.userVote;
    console.error('comment vote failed', e);
  } finally {
    c.voteBusy = false;
  }
}


function shareComment(c) {
  const url = `${window.location.origin}/community/${thoughtId}#${c.id}`;
  navigator.clipboard.writeText(url);
}

onMounted(async () => {
  await loadThought();
  await loadComments();
});


const voteBusy = ref(false);

function applyOptimistic(th, nextValue) {
  // remove previous contribution
  if ((th.userVote || 0) === 1) th.upvotes = Math.max(0, (th.upvotes || 0) - 1);
  if ((th.userVote || 0) === -1) th.downvotes = Math.max(0, (th.downvotes || 0) - 1);

  // apply new contribution
  if (nextValue === 1) th.upvotes = (th.upvotes || 0) + 1;
  if (nextValue === -1) th.downvotes = (th.downvotes || 0) + 1;

  th.userVote = nextValue;
}

function applyOptimisticComment(c, nextValue) {
  if ((c.userVote || 0) === 1) c.upvotes = Math.max(0, (c.upvotes || 0) - 1);
  if ((c.userVote || 0) === -1) c.downvotes = Math.max(0, (c.downvotes || 0) - 1);

  if (nextValue === 1) c.upvotes = (c.upvotes || 0) + 1;
  if (nextValue === -1) c.downvotes = (c.downvotes || 0) + 1;

  c.userVote = nextValue;
}

</script>
